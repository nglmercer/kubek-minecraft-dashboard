<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minecraft Mods Search</title>
  <link rel="stylesheet" href="/css/globals.css" data-purpose="twind">
  <script src="js/modalcomponents.js"></script>

</head>
<body class="bg-black text-white min-h-screen">
  <custom-modal id="custom-modal" style="max-height: 100vh; overflow-y: scroll;">
    <mod-search></mod-search>
  
  </custom-modal>
  <button class="btn-primary" id="mod-search-button" >{{commons.plugins}}</button>


  <template id="mod-card-template">
    <div class="bg-gray-800 rounded-lg p-4 hover:bg-gray-700 transition-colors cursor-pointer">
      <div class="flex items-center gap-4">
        <img class="w-16 h-16 rounded-lg object-cover" src="" alt="Mod icon">
        <div>
          <h3 class="text-xl font-bold"></h3>
          <p class="text-gray-400 line-clamp-2"></p>
        </div>
      </div>
    </div>
  </template>

  <template id="mod-details-template">
    <div class="max-w-4xl mx-auto">
      <button class="mb-4 text-blue-500 hover:text-blue-400" id="back-button">← Back to results</button>
      <div class="bg-gray-800 rounded-lg p-6">
        <div class="flex items-start gap-6">
          <img class="w-32 h-32 rounded-lg object-cover" src="" alt="Mod icon">
          <div class="flex-1">
            <h1 class="text-3xl font-bold mb-2"></h1>
            <div class="flex gap-4 mb-4">
              <span class="bg-gray-700 px-3 py-1 rounded-full text-sm"></span>
              <span class="bg-gray-700 px-3 py-1 rounded-full text-sm"></span>
            </div>
            <p class="text-gray-300 mb-6"></p>
            <div class="flex gap-4 mb-6">
              <select class="bg-gray-700 px-4 py-2 rounded" id="version-filter">
                <option value="">All Versions</option>
              </select>
              <select class="bg-gray-700 px-4 py-2 rounded" id="loader-filter">
                <option value="">All Loaders</option>
              </select>
            </div>
            <div class="space-y-2 max-h-70dvh overflow-y-auto" id="versions-list"></div>
          </div>
        </div>
      </div>
    </div>
  </template>

<script>
  async function loadGlobalStyles(element = 0) {
  // 1. Buscar el tag <link> con los estilos
  const styleLinks = document.querySelectorAll('link[rel="stylesheet"]');
  const styleLink = styleLinks[element]; // Selecciona el segundo enlace
  if (!styleLink) {
    console.error('No se encontró enlace a hoja de estilos');
    return '';
  }

  try {
    // 2. Hacer fetch al archivo CSS
    const response = await fetch(styleLink.href);
    return await response.text();
  } catch (error) {
    console.error('Error cargando estilos:', error);
    return '';
  }
}

const API_BASE = "https://api.modrinth.com/v2";
const SEARCH_API = `${API_BASE}/search`;
const PROJECT_API = `${API_BASE}/project`;
const connect_plugin = [
  {
    title: "minekube-connect",
    description: " Minecraft Plugin for Connect, allows tunneled player connections from Connect Network to join Spigot/Paper server and Velocity/BungeeCord proxy, even in online mode! ",
    icon_url: "https://avatars.githubusercontent.com/u/51905918?s=48&v=4",
    versions: [
      {
        version_number: "1.0.0",
        files:[ "https://github.com/minekube/connect-java/releases/download/latest/connect-bungee.jar"],
        filename: "connect-bungee.jar",
        loaders: ["BungeeCord"],
        game_versions: ["1.8-1.20.6"],
      },
      {
        files:[ "https://github.com/minekube/connect-java/releases/download/latest/connect-spigot.jar"],
        filename: "connect-spigot.jar",
        version_number: "1.0.0",
        loaders: ["Spigot"],
        game_versions: ["1.8-1.20.6"],
      }
      ,{
        files:[ "https://github.com/minekube/connect-java/releases/download/latest/connect-velocity.jar"],
        filename: "connect-velocity.jar",
        version_number: "1.0.0",
        loaders: ["Velocity"],
        game_versions: ["1.8-1.20.6"],
      }
    ],
    author: "Tú",
    customField: "Support up to Minecraft 1.20.6 (robinbraemer)",
  }
]
class ModSearch extends HTMLElement {
  constructor() {
    super();
    this.attachShadow({ mode: 'open', delegatesFocus: true });
    this.shadowRoot.innerHTML = `
      <div class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto mb-8">
          <input type="text" 
                 class="w-full bg-gray-800 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" 
                 placeholder="Search mods or plugins...">
        </div>
        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3 max-h-70dvh overflow-y-auto" id="results"></div>
      </div>
    `;
  }

  async connectedCallback() {
    const css = await loadGlobalStyles();
    const style = document.createElement('style');
    style.textContent = css;
    this.shadowRoot.prepend(style);
    this.input = this.shadowRoot.querySelector('input');
    this.resultsContainer = this.shadowRoot.getElementById('results');
    this.input.addEventListener('input', this.handleSearch.bind(this));
    this.loadResults(); // Cargar resultados iniciales
  }
  addCustomMods(customMods) {
    if (!customMods) return;
    const processed = customMods.map(mod => ({
      ...mod,
      isCustom: true, // Flag para identificar mods personalizados
      slug: mod.id || Math.random().toString(36).substr(2, 9) // ID único si no existe
    }));
    
    this.displayResults(processed, true);
  }

  // Función para cargar resultados iniciales
  async loadResults() {
    try {
      const response = await fetch(`${SEARCH_API}?query=minecraft`);
      const data = await response.json();
      this.displayResults(data.hits);
      this.addCustomMods(connect_plugin);
    } catch (error) {
      console.error('Error loading initial results:', error);
    }
  }

  async handleSearch(e) {
    const query = e.target.value;
    if (query.length < 2) {
      this.loadResults(); // Volver a cargar resultados iniciales si la búsqueda es muy corta
      return;
    }
    
    try {
      const response = await fetch(`${SEARCH_API}?query=${encodeURIComponent(query)}`);
      const data = await response.json();
      this.displayResults(data.hits);
    } catch (error) {
      console.error('Search error:', error);
    }
  }


  displayResults(results, isCustom = false) {
    this.resultsContainer.innerHTML = '';
    const template = document.getElementById('mod-card-template');
    
    results.forEach(project => {
      const clone = template.content.cloneNode(true);
      const card = clone.querySelector('div');
      card.querySelector('h3').textContent = project.title || project.name;
      card.querySelector('p').textContent = project.description;
      
      const img = card.querySelector('img');
      img.src = project.icon_url || project.image || 'https://via.placeholder.com/100';
      
      card.addEventListener('click', () => {
        if(project.isCustom) {
          const details = document.createElement('mod-details');
          details.project = project; // Pasamos el objeto completo
          this.shadowRoot.appendChild(details);
          this.shadowRoot.querySelector('.container').hidden = true;
        } else {
          this.showModDetails(project.slug);
        }
      });
      
      this.resultsContainer.appendChild(clone);
    });
  }

  async showModDetails(slug) {
    try {
      const [projectRes, versionsRes] = await Promise.all([
        fetch(`${PROJECT_API}/${slug}`),
        fetch(`${PROJECT_API}/${slug}/version`)
      ]);
      
      const project = await projectRes.json();
      const versions = await versionsRes.json();
      
      const details = document.createElement('mod-details');
      details.project = { ...project, versions };
      this.shadowRoot.appendChild(details);
      this.shadowRoot.querySelector('.container').hidden = true;
    } catch (error) {
      console.error('Error fetching details:', error);
    }
  }
}

class ModDetails extends HTMLElement {
  set project(value) {
    this._project = value;
    this.render();
  }

  constructor() {
    super();
    this.attachShadow({ mode: 'open', delegatesFocus: true });
    this.shadowRoot.innerHTML = document.getElementById('mod-details-template').innerHTML;
  }

  async connectedCallback() {
    const css = await loadGlobalStyles();
    const style = document.createElement('style');
    style.textContent = css;
    this.shadowRoot.prepend(style);
    this.shadowRoot.getElementById('back-button').addEventListener('click', () => {
      this.remove();
      document.querySelector('mod-search').shadowRoot.querySelector('.container').hidden = false;
    });
  }

  render() {
    const { title, description, project_type, versions, icon_url } = this._project;
    
    this.shadowRoot.querySelector('h1').textContent = title;
    this.shadowRoot.querySelector('p').textContent = description;
    this.shadowRoot.querySelector('img').src = icon_url || 'https://via.placeholder.com/128';
    this.shadowRoot.querySelector('span:first-child').textContent = project_type;
    const uniqueVersions = [...new Set(versions.flatMap(v => v.game_versions))];
    const versionSelect = this.shadowRoot.getElementById('version-filter');
    versionSelect.innerHTML = '<option value="">All Versions</option>';
    uniqueVersions.forEach(v => {
      versionSelect.innerHTML += `<option value="${v}">${v}</option>`;
    });

    const uniqueLoaders = [...new Set(versions.flatMap(v => v.loaders))];
    const loaderSelect = this.shadowRoot.getElementById('loader-filter');
    loaderSelect.innerHTML = '<option value="">All Loaders</option>';
    uniqueLoaders.forEach(loader => {
      loaderSelect.innerHTML += `<option value="${loader}">${loader}</option>`;
    });

    versionSelect.addEventListener('change', this.filterVersions.bind(this));
    loaderSelect.addEventListener('change', this.filterVersions.bind(this));
    
    this.filterVersions();
  }

  filterVersions() {
    const versionFilter = this.shadowRoot.getElementById('version-filter').value;
    const loaderFilter = this.shadowRoot.getElementById('loader-filter').value;
    
    const filtered = this._project.versions.filter(v => {
      return (!versionFilter || v.game_versions.includes(versionFilter)) &&
             (!loaderFilter || v.loaders.includes(loaderFilter));
    });

    const versionsList = this.shadowRoot.getElementById('versions-list');
    versionsList.innerHTML = '';

    filtered.forEach(version => {
    // 1. Obtener game_versions de la versión o del proyecto
    const gameVersions = version.game_versions 
      ? version.game_versions 
      : this._project.game_versions || []; // Si no hay en versión, usar los del proyecto

    // 2. Sanitizar y formatear
    const parsedGameVersions = gameVersions.map(v => v.replaceAll('.', '.')) || [];

    const div = document.createElement('div');
    div.className = 'bg-gray-700 p-4 rounded-lg';
    div.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <span class="font-bold">${version.version_number}</span>
          <span class="text-gray-400 ml-2">${parsedGameVersions.join(', ')}</span>
        </div>
        <button class="download-button px-4 py-2 rounded hover:bg-blue-600">
          Download
        </button>
      </div>
      <div class="mt-2 text-sm text-gray-400">
        ${version.loaders ? `Loaders: ${version.loaders.join(', ')}` : ''} 
      </div>
    `;
    // Añade el event listener para el custom event
    const button = div.querySelector('button');
    button.addEventListener('click', () => {
      const downloadEvent = new CustomEvent('download-request', {
        detail: version,
        bubbles: true,
        composed: true
      });
      this.dispatchEvent(downloadEvent);
    });
    /* get {
          url: version.files[0].url,
          filename: version.files[0].filename,
          version: version.version_number,
          modName: this._project.title,
          versionraw: version
        },
    */
    versionsList.appendChild(div);
  });
  }
}

customElements.define('mod-search', ModSearch);
customElements.define('mod-details', ModDetails);
document.addEventListener('download-request', (e) => {
  console.log('Descargar:', e.detail);
});
const modSearch = document.querySelector('mod-search');
// get discovery/list
async function getDiscoveryList() {
  const response = await fetch('/api/discovery/list');
  const data = await response.json();
  console.log('data', data);
  return data;
}

console.log("getDiscoveryList", getDiscoveryList());
</script>
<script>
    document.getElementById('mod-search-button').addEventListener('click', () => {
  document.getElementById('custom-modal').open();
});
</script>
</body>
</html>