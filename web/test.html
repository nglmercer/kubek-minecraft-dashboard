<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minecraft Mods Search</title>
  <style>
    /* Global CSS Styles */
    :root {
      --bg-black: #000;
      --text-white: #fff;
      --bg-blue-600: #2563eb;
      --bg-gray-800: #1f2937;
      --bg-gray-700: #374151;
      --text-gray-400: #9ca3af;
      --text-blue-500: #3b82f6;
      --bg-blue-500: #3b82f6;
      --rounded-lg: 0.5rem;
      --rounded-full: 9999px;
    }

    body {
      background-color: var(--bg-black);
      color: var(--text-white);
      min-height: 100vh;
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
    }

    .container {
      width: 100%;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    .mx-auto {
      margin-left: auto;
      margin-right: auto;
    }
    .w-16 { width: 4rem; }
    .w-32 { width: 8rem; }
    .h-16 { height: 4rem; }
    .h-32 { height: 8rem; }
    .max-w-2xl { max-width: 42rem; }
    .max-w-4xl { max-width: 56rem; }
    
    .grid {
      display: grid;
      gap: 1rem;
    }

    .flex {
      display: flex;
    }

    .items-center { align-items: center; }
    .items-start { align-items: flex-start; }
    .justify-between { justify-content: space-between; }
    .gap-4 { gap: 1rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-8 { margin-bottom: 2rem; }
    .p-4 { padding: 1rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .w-full { width: 100%; }
    .rounded-lg { border-radius: var(--rounded-lg); }
    .object-cover { object-fit: cover; }
    .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
    .font-bold { font-weight: 700; }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Hover states */
    .hover\:bg-gray-700:hover { background-color: var(--bg-gray-700); }
    .hover\:text-blue-400:hover { color: #60a5fa; }
    .hover\:bg-blue-600:hover { background-color: #2563eb; }

    /* Transitions */
    .transition-colors { transition-property: background-color; transition-duration: 150ms; }

    /* Responsive grid */
    @media (min-width: 768px) {
      .md\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (min-width: 1024px) {
      .lg\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    /* Custom classes */
    .mod-card {
      background-color: var(--bg-gray-800);
      cursor: pointer;
    }

    .mod-details-container {
      background-color: var(--bg-gray-800);
    }

    .version-tag {
      background-color: var(--bg-gray-700);
      font-size: 0.875rem;
      border-radius: var(--rounded-full);
    }

    .rounded {
    border-radius: 0.25rem;
  }
  
  .download-button {
    background-color: var(--bg-blue-500);
    color: var(--text-white);
    border: none;
    cursor: pointer;
  }
  </style>
</head>
<body class="bg-black text-white min-h-screen">
  <mod-search></mod-search>

  <template id="mod-card-template">
    <div class="bg-gray-800 rounded-lg p-4 hover:bg-gray-700 transition-colors cursor-pointer">
      <div class="flex items-center gap-4">
        <img class="w-16 h-16 rounded-lg object-cover" src="" alt="Mod icon">
        <div>
          <h3 class="text-xl font-bold"></h3>
          <p class="text-gray-400 line-clamp-2"></p>
        </div>
      </div>
    </div>
  </template>

  <template id="mod-details-template">
    <div class="max-w-4xl mx-auto">
      <button class="mb-4 text-blue-500 hover:text-blue-400" id="back-button">← Back to results</button>
      <div class="bg-gray-800 rounded-lg p-6">
        <div class="flex items-start gap-6">
          <img class="w-32 h-32 rounded-lg object-cover" src="" alt="Mod icon">
          <div class="flex-1">
            <h1 class="text-3xl font-bold mb-2"></h1>
            <div class="flex gap-4 mb-4">
              <span class="bg-gray-700 px-3 py-1 rounded-full text-sm"></span>
              <span class="bg-gray-700 px-3 py-1 rounded-full text-sm"></span>
            </div>
            <p class="text-gray-300 mb-6"></p>
            <div class="flex gap-4 mb-6">
              <select class="bg-gray-700 px-4 py-2 rounded" id="version-filter">
                <option value="">All Versions</option>
              </select>
              <select class="bg-gray-700 px-4 py-2 rounded" id="loader-filter">
                <option value="">All Loaders</option>
              </select>
            </div>
            <div class="space-y-2" id="versions-list"></div>
          </div>
        </div>
      </div>
    </div>
  </template>

<script>
const Globalcss = `
  ${document.querySelector('style').innerHTML}
`
const API_BASE = "https://api.modrinth.com/v2";
const SEARCH_API = `${API_BASE}/search`;
const PROJECT_API = `${API_BASE}/project`;
const connect_plugin = [
  {
    title: "minekube-connect",
    description: " Minecraft Plugin for Connect, allows tunneled player connections from Connect Network to join Spigot/Paper server and Velocity/BungeeCord proxy, even in online mode! ",
    icon_url: "https://avatars.githubusercontent.com/u/51905918?s=48&v=4",
    versions: [
      {
        version_number: "1.0.0",
        files:[ "https://github.com/minekube/connect-java/releases/download/latest/connect-bungee.jar"],
        filename: "connect-bungee.jar",
        loaders: ["BungeeCord"],
        game_versions: ["1.8-1.20.6"],
      },
      {
        files:[ "https://github.com/minekube/connect-java/releases/download/latest/connect-spigot.jar"],
        filename: "connect-spigot.jar",
        version_number: "1.0.0",
        loaders: ["Spigot"],
        game_versions: ["1.8-1.20.6"],
      }
      ,{
        files:[ "https://github.com/minekube/connect-java/releases/download/latest/connect-velocity.jar"],
        filename: "connect-velocity.jar",
        version_number: "1.0.0",
        loaders: ["Velocity"],
        game_versions: ["1.8-1.20.6"],
      }
    ],
    author: "Tú",
    customField: "Support up to Minecraft 1.20.6 (robinbraemer)",
  }
]
class ModSearch extends HTMLElement {
  constructor() {
    super();
    this.attachShadow({ mode: 'open', delegatesFocus: true });
    this.shadowRoot.innerHTML = `
      <style>${Globalcss}</style>
      <div class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto mb-8">
          <input type="text" 
                 class="w-full bg-gray-800 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" 
                 placeholder="Search mods or plugins...">
        </div>
        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3" id="results"></div>
      </div>
    `;
  }

  connectedCallback() {
    this.input = this.shadowRoot.querySelector('input');
    this.resultsContainer = this.shadowRoot.getElementById('results');
    this.input.addEventListener('input', this.handleSearch.bind(this));
    this.loadResults(); // Cargar resultados iniciales
  }
  addCustomMods(customMods) {
    if (!customMods) return;
    const processed = customMods.map(mod => ({
      ...mod,
      isCustom: true, // Flag para identificar mods personalizados
      slug: mod.id || Math.random().toString(36).substr(2, 9) // ID único si no existe
    }));
    
    this.displayResults(processed, true);
  }

  // Función para cargar resultados iniciales
  async loadResults() {
    try {
      const response = await fetch(`${SEARCH_API}?query=minecraft`);
      const data = await response.json();
      this.displayResults(data.hits);
      this.addCustomMods(connect_plugin);
    } catch (error) {
      console.error('Error loading initial results:', error);
    }
  }

  async handleSearch(e) {
    const query = e.target.value;
    if (query.length < 2) {
      this.loadResults(); // Volver a cargar resultados iniciales si la búsqueda es muy corta
      return;
    }
    
    try {
      const response = await fetch(`${SEARCH_API}?query=${encodeURIComponent(query)}`);
      const data = await response.json();
      this.displayResults(data.hits);
    } catch (error) {
      console.error('Search error:', error);
    }
  }


  displayResults(results, isCustom = false) {
    this.resultsContainer.innerHTML = '';
    const template = document.getElementById('mod-card-template');
    
    results.forEach(project => {
      const clone = template.content.cloneNode(true);
      const card = clone.querySelector('div');
      card.querySelector('h3').textContent = project.title || project.name;
      card.querySelector('p').textContent = project.description;
      
      const img = card.querySelector('img');
      img.src = project.icon_url || project.image || 'https://via.placeholder.com/100';
      
      card.addEventListener('click', () => {
        if(project.isCustom) {
          const details = document.createElement('mod-details');
          details.project = project; // Pasamos el objeto completo
          this.shadowRoot.appendChild(details);
          this.shadowRoot.querySelector('.container').hidden = true;
        } else {
          this.showModDetails(project.slug);
        }
      });
      
      this.resultsContainer.appendChild(clone);
    });
  }

  async showModDetails(slug) {
    try {
      const [projectRes, versionsRes] = await Promise.all([
        fetch(`${PROJECT_API}/${slug}`),
        fetch(`${PROJECT_API}/${slug}/version`)
      ]);
      
      const project = await projectRes.json();
      const versions = await versionsRes.json();
      
      const details = document.createElement('mod-details');
      details.project = { ...project, versions };
      this.shadowRoot.appendChild(details);
      this.shadowRoot.querySelector('.container').hidden = true;
    } catch (error) {
      console.error('Error fetching details:', error);
    }
  }
}

class ModDetails extends HTMLElement {
  set project(value) {
    this._project = value;
    this.render();
  }

  constructor() {
    super();
    this.attachShadow({ mode: 'open', delegatesFocus: true });
    this.shadowRoot.innerHTML = document.getElementById('mod-details-template').innerHTML;
    const globalcssstyle = document.createElement('style');
    globalcssstyle.innerHTML = Globalcss;
    this.shadowRoot.appendChild(globalcssstyle);
  }

  connectedCallback() {
    this.shadowRoot.getElementById('back-button').addEventListener('click', () => {
      this.remove();
      document.querySelector('mod-search').shadowRoot.querySelector('.container').hidden = false;
    });
  }

  render() {
    const { title, description, project_type, versions, icon_url } = this._project;
    
    this.shadowRoot.querySelector('h1').textContent = title;
    this.shadowRoot.querySelector('p').textContent = description;
    this.shadowRoot.querySelector('img').src = icon_url || 'https://via.placeholder.com/128';
    this.shadowRoot.querySelector('span:first-child').textContent = project_type;
    const uniqueVersions = [...new Set(versions.flatMap(v => v.game_versions))];
    const versionSelect = this.shadowRoot.getElementById('version-filter');
    versionSelect.innerHTML = '<option value="">All Versions</option>';
    uniqueVersions.forEach(v => {
      versionSelect.innerHTML += `<option value="${v}">${v}</option>`;
    });

    const uniqueLoaders = [...new Set(versions.flatMap(v => v.loaders))];
    const loaderSelect = this.shadowRoot.getElementById('loader-filter');
    loaderSelect.innerHTML = '<option value="">All Loaders</option>';
    uniqueLoaders.forEach(loader => {
      loaderSelect.innerHTML += `<option value="${loader}">${loader}</option>`;
    });

    versionSelect.addEventListener('change', this.filterVersions.bind(this));
    loaderSelect.addEventListener('change', this.filterVersions.bind(this));
    
    this.filterVersions();
  }

  filterVersions() {
    const versionFilter = this.shadowRoot.getElementById('version-filter').value;
    const loaderFilter = this.shadowRoot.getElementById('loader-filter').value;
    
    const filtered = this._project.versions.filter(v => {
      return (!versionFilter || v.game_versions.includes(versionFilter)) &&
             (!loaderFilter || v.loaders.includes(loaderFilter));
    });

    const versionsList = this.shadowRoot.getElementById('versions-list');
    versionsList.innerHTML = '';

    filtered.forEach(version => {
    // 1. Obtener game_versions de la versión o del proyecto
    const gameVersions = version.game_versions 
      ? version.game_versions 
      : this._project.game_versions || []; // Si no hay en versión, usar los del proyecto

    // 2. Sanitizar y formatear
    const parsedGameVersions = gameVersions.map(v => v.replaceAll('.', '.')) || [];

    const div = document.createElement('div');
    div.className = 'bg-gray-700 p-4 rounded-lg';
    div.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <span class="font-bold">${version.version_number}</span>
          <span class="text-gray-400 ml-2">${parsedGameVersions.join(', ')}</span>
        </div>
        <button class="download-button px-4 py-2 rounded hover:bg-blue-600">
          Download
        </button>
      </div>
      <div class="mt-2 text-sm text-gray-400">
        ${version.loaders ? `Loaders: ${version.loaders.join(', ')}` : ''} 
      </div>
    `;
    // Añade el event listener para el custom event
    const button = div.querySelector('button');
    button.addEventListener('click', () => {
      const downloadEvent = new CustomEvent('download-request', {
        detail: version,
        bubbles: true,
        composed: true
      });
      this.dispatchEvent(downloadEvent);
    });
    /* get {
          url: version.files[0].url,
          filename: version.files[0].filename,
          version: version.version_number,
          modName: this._project.title,
          versionraw: version
        },
    */
    versionsList.appendChild(div);
  });
  }
}

customElements.define('mod-search', ModSearch);
customElements.define('mod-details', ModDetails);
document.addEventListener('download-request', (e) => {
  console.log('Descargar:', e.detail);
});
const modSearch = document.querySelector('mod-search');

// Añadir mods personalizados

</script>
</body>
</html>