<!DOCTYPE html>

<head>
    <!-- Meta -->
    <meta charset="utf-8"/>
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Kubek</title>

    <!-- Styles -->
    <link rel="stylesheet" href="css/animate.min.css"/>
    <link rel="stylesheet" href="css/atom-one-dark.css">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <!-- Elements styles -->
    <link rel="stylesheet" href="css/elements/elements.css"/>

    <link rel="stylesheet" href="css/preloader.css"/>
    <link rel="stylesheet" href="css/mobile.css"/>
    <link rel="stylesheet" href="css/globals.css"/>
    <link rel="stylesheet" href="css/theme.css"/>

    <link rel="stylesheet" href="assets/fonts/Gilroy/stylesheet.css"/>
    <link rel="stylesheet" href="assets/fonts/RobotoMono/stylesheet.css"/>
    <link rel="stylesheet" href="assets/fonts/MSR/stylesheet.css"/>

    <!-- Scripts -->
     <script src="js/utils.js"></script>
     <script src="js/webcomponents.js"></script>
    <script src="js/jquery-3.7.0.min.js"></script>
    <script src="js/moment.min.js"></script>
    <script src="js/base64.min.js"></script>
    <script src="js/highlight.min.js"></script>
    <script src="js/mineParse.js"></script>
    <script src="js/ANSIParse.js"></script>

    <!-- Classes -->
    <script src="js/classes/KubekPredefined.js"></script>
    <script src="js/classes/KubekUI.js"></script>
    <script src="js/classes/KubekPageManager.js"></script>
    <script src="js/classes/KubekDropdowns.js"></script>
    <script src="js/classes/KubekServers.js"></script>
    <script src="js/classes/KubekServerHeaderUI.js"></script>
    <script src="js/classes/KubekRequests.js"></script>
    <script src="js/classes/KubekRefresher.js"></script>
    <script src="js/classes/KubekAlerts.js"></script>
    <script src="js/classes/KubekPlugins.js"></script>
    <script src="js/classes/KubekFileManager.js"></script>
    <script src="js/classes/KubekUtils.js"></script>
    <script src="js/classes/KubekHardware.js"></script>
    <script src="js/classes/KubekCircleProgress.js"></script>
    <script src="js/classes/KubekCoresManager.js"></script>
    <script src="js/classes/KubekJavaManager.js"></script>
    <script src="js/classes/KubekTasksUI.js"></script>
    <script src="js/classes/KubekNotifyModal.js"></script>
    <script src="/sections/sidebar.js"></script>

</head>

<body>
    <dialog-container
     id="Eula_dialog_container" 
     required="true"
    >
        <custom-dialog id="Eula_dialog" 
        title=""
        description="{{commons.eula}}"
        style=" max-width: 500px; color: white;"
        theme="dark"
        >
        </custom-dialog>
    </dialog-container>
    <sidebar-menu style="font-family: material-symbols-outlined"></sidebar-menu>

<div class="main-layout">
    <div id="content-place" class="content"></div>
</div>

<div class="preloader" id="main-preloader">
    <div class="lds-ellipsis">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
    </div>
</div>

<div class="blurScreen" style="display: none"></div>

<div class="uiPool bottom left" id="alerts-pool"></div>
<div class="uiPool bottom right" id="tasks-pool"></div>

</body>
<script>
    const Eula_dialog = document.querySelector("#Eula_dialog");
    Eula_dialog.options = [
        {
            label: "{{commons.iAccept}}",
            class: "save-btn",
            callback: () => {
                console.log("accept");
                KubekRequests.get("/kubek/eula/accept", function () {
                    window.location.reload();
                });
            }
        }
        ];	
console.log("[UI] Starting Kubek UI...");
const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);
let act = urlParams.get("act");
let selectedServer = window.localStorage.selectedServer || "";
let consoleRamUsageBar, consoleCpuUsageBar;

document.addEventListener('DOMContentLoaded', function () { 
    KubekRequests.get("/kubek/settings", (settings) => {
        console.log("settings /kubek/settings",settings);
        if (settings.eulaAccepted === false) {
            document.querySelector("#Eula_dialog_container").show();
        }
    });

    KubekRequests.get("/updates", (update) => {
        if (update.hasUpdate === true) {
            KubekAlerts.addAlert("{{commons.updateAvailable}}", "update", update.version.new, 6000, "colored", () => {
                KubekNotifyModal.create("<h2>{{commons.updateAvailable}}</h2><div style='display: flex; align-items: center; justify-content: center;'>" + update.version.current + " <span class='material-symbols-rounded' style='font-size: 18pt; margin: 0 12px;'>navigate_next</span> " + update.version.new + "</div>", update.body.replaceAll("\n", "<br>"), "{{commons.goto}}", "update", () => {
                    window.open(update.url, "_blank");
                }, KubekPredefined.MODAL_CANCEL_BTN);
            });
        }
    });
    setTimeout(() => {
        console.log("servers","loadServersList");
        KubekUI.loadServersList();
    }, 1000);
    // Загружаем все секции
    KubekUI.loadSection("content-header", ".main-layout", () => {
        KubekUI.loadSelectedServer();
        KubekUI.loadSection("sidebar", ".main-layout", () => {
            KubekUI.loadServersList();

            KubekServers.getServersList((servers) => {
                if (servers.length === 0) {
                    console.log("servers","loadServersList if",servers);
                    document.querySelector(".content-header").style.display = "none";
                    if (act !== "newServer") {
                        KubekPageManager.gotoPage("welcome");
                    } else {
                        KubekPageManager.gotoPage("newServer");
                    }
                } else {
                    console.log("servers","loadServersList if else",servers);
                    // Проверим существование сервера
                    if (act !== null) {
                        console.log("[UI]", "act is not null, trying to load", act);
                        KubekPageManager.gotoPage(act);
                        if (!selectedServer) return;
                    } else {
                        console.log("[UI]", "act is null, loading console", act);
                        KubekPageManager.gotoPage("console");
                    }
                    KubekServers.getServersList((serversList) => {
                        if (!serversList || !selectedServer) return;
                        if (!serversList.includes(selectedServer)) {
                            window.localStorage.selectedServer = serversList[0];
                            window.location.reload();
                        }
                    });
                    // Ищем act и загружаем страницу

                }
            });

            KubekUI.loadSection("header", ".main-layout", () => {
                KubekUI.hidePreloader();
                KubekRefresher.refreshConsoleLog();
                KubekRefresher.addRefreshServerLogInterval();
                KubekRefresher.addRefreshServerHeaderInterval();
                KubekRefresher.addRefreshUsageInterval();
                KubekRefresher.addRefreshTasksInterval();
                // TODO
            });
        });
    });

    KubekRequests.get("/kubek/rawlanguages", (langs) => {
        localStorage.setItem("rawlanguages", JSON.stringify(langs));
    });
});
function uploadServerIcon() {
    // Obtener el elemento input
    const inputElement = document.getElementById('server-icon-input');
    
    // Simular click en el input para abrir el selector de archivos
    inputElement.click();
    
    // Remover event listeners previos para evitar duplicados
    inputElement.removeEventListener('change', handleFileChange);
    
    // Agregar nuevo event listener
    inputElement.addEventListener('change', handleFileChange);
    
    // Función para manejar el cambio de archivo
    function handleFileChange() {
        // Crear FormData a partir del formulario
        const formElement = document.getElementById('server-icon-form');
        const formData = new FormData(formElement);
        
        // Realizar la petición POST
        KubekRequests.post(`/servers/${selectedServer}/icon`, () => {
            // Recargar la UI después de subir el ícono
            KubekServerHeaderUI.loadServerByName(selectedServer, () => {
                KubekUI.loadServersList();
            });
        }, formData);
    }
}
</script>

<style>
    body,
    html {
        padding: 0;
        margin: 0;
        background: var(--bg-dark);
    }

    /* Main layout styling */
    .main-layout {
        width: 100vw;
        height: 100vh;
        overflow-y: auto;
        overflow-x: hidden;
        display: grid;
        grid-template-columns: 1fr 280px 32px 1024px 1fr;
        grid-template-rows: max-content max-content 1fr;
        grid-auto-columns: 1fr;
        gap: 24px 0em;
        grid-auto-flow: row;
        grid-template-areas:
      "header header header header header"
      ". sidebar . content-header ."
      ". sidebar . content .";
    }

    .main-layout .sidebar {
        grid-area: sidebar;
    }

    .main-layout .content {
        grid-area: content;
    }
</style>

<script>
    //* Sidebar*/
    document.addEventListener("DOMContentLoaded", () => {
  console.log("sidebar", document.querySelector('sidebar-menu'));

    setTimeout(() => {
      document.querySelector('#menu-btn').addEventListener('click', () => {
        document.querySelector('sidebar-menu').toggleSidebar();
        console.log("toggleSidebar", document.querySelector('sidebar-menu'));
    });

        const sidebar = document.querySelector('sidebar-menu');
        sidebar.addEventListener('page-change', (event) => {
          const detail = event.detail;
          console.log('Changing to page:', detail.page);
          KubekUI.changeItemByPage(detail.page);
          KubekPageManager.gotoPage(detail.page);
        });
        setTimeout(() => {
          if (window.location.search.includes("act")) {
            sidebar.setActiveElement(window.location.search.split("act=")[1]);
          } else 
          if (window.localStorage.selectedServer) {
            sidebar.setActiveElement(window.localStorage.selectedServer);
          }
        }, 555);
        sidebar.addEventListener('new-server', () => {
          console.log('Creating new server');
          // Add your new server logic here
          // href="/?act=newServer"
          window.location = '/?act=newServer';
        });
      
        sidebar.addEventListener('toggle-sidebar', () => {
          console.log('Toggling sidebar');
          // Add your sidebar toggle logic here
        });
        sidebar.addEventListener('server-change', (event) => {
        //window.localStorage.selectedServer = `test1231`; window.location.reload()
          console.log('Changing to server:', event.detail);
          window.localStorage.selectedServer = event.detail.server;
          if (window.location.search.includes("newServer")) {
            KubekPageManager.gotoPage("console");
          } else {
            window.location.reload();
          }
        });
    }, 555);
});
</script>